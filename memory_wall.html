<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Farewell Memory Wall</title>
    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Segoe+UI&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", sans-serif;
      }
      body {
        background: #000;
        color: #fff;
        overflow-x: hidden;
      }

      /* ================= MAIN ================= */
      .main-page {
        min-height: 100vh;
        position: relative;
        display: block; /* Always visible in this file */
      }
      .main-video {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -2;
      }
      .main-page::after {
        content: "";
        position: fixed;
        inset: 0;
        background: rgba(
          0,
          0,
          0,
          0.7
        ); /* Darker overlay for content readability */
        z-index: -1;
        pointer-events: none;
      }
      .content {
        padding: 40px 20px;
        max-width: 1200px;
        margin: 0 auto;
        text-align: center;
      }

      /* Rectangle Welcome Button */
      .enter-btn {
        width: 240px;
        height: 55px;
        border-radius: 14px;
        border: none;
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: #000;
        font-size: 1.2rem;
        font-weight: 600;
        letter-spacing: 1px;
        cursor: pointer;
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        animation: pulseGlow 3s infinite;
      }

      @keyframes pulseGlow {
        0% {
          box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        50% {
          box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }
        100% {
          box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
      }

      /* --- Ultra Futuristic Gallery Styles (Redesign) --- */
      :root {
        --bg: #020617;
        --overlay-bg: rgba(15, 23, 42, 0.9);
        --accent: #FFD700;
        --text: #e5e7eb;
      }
      
      /* Dock Container - Bottom Right */
      .dock-container {
        position: fixed;
        bottom: 30px;
        right: 30px; /* Moved to right */
        left: auto;  /* Unset left */
        display: flex;
        justify-content: flex-end;
        z-index: 100;
        pointer-events: none; 
      }

      /* The Glass Dock */
      .glass-dock {
        pointer-events: auto;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 12px;
        padding: 10px 15px;
        background: rgba(15, 23, 42, 0.4);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 50px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .glass-dock:hover {
          transform: translateY(-5px);
          background: rgba(15, 23, 42, 0.9);
          box-shadow: 0 15px 50px rgba(0,0,0,0.7);
      }

      /* Dock Buttons */
      .dock-btn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        border: 1px solid rgba(255,255,255,0.05);
        background: rgba(255, 255, 255, 0.03);
        color: #94a3b8;
        font-size: 1.1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }
      .dock-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        transform: scale(1.1);
        border-color: rgba(255,255,255,0.2);
      }
      
      .dock-btn.primary {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: black;
        width: 55px;
        height: 55px; /* Bigger center button */
        font-size: 2rem;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
      }
      .dock-btn.primary:hover {
        transform: translateY(-8px) scale(1.1);
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
      }

      /* Dock Search */
      .dock-search-wrapper {
          position: relative;
          width: 0;
          overflow: hidden;
          transition: width 0.4s ease;
          border-radius: 20px;
      }
      .glass-dock:hover .dock-search-wrapper,
      .dock-search-wrapper:focus-within {
          width: 200px; /* Expand on hover/focus */
      }
      
      .dock-search-wrapper input {
        width: 100%;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255,255,255,0.1);
        color: white;
        padding: 10px 15px;
        border-radius: 20px;
        outline: none;
        font-size: 0.9rem;
      }
      .dock-search-wrapper input::placeholder { color: rgba(255,255,255,0.4); }

      /* Inputs (General for Modal) */
      .gallery-inputs input, 
      .gallery-inputs select, 
      .gallery-inputs textarea {
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(2, 6, 23, 0.8);
        color: white;
        padding: 8px 10px;
        font-family: "Segoe UI", sans-serif;
      }

      /* Gallery Grid - Masonry-ish Feel */
      .gallery {
        columns: 4 240px;
        column-gap: 20px;
        margin-bottom: 40px;
      }

      /* Card Styles (Clean Grid) */
      .card {
        break-inside: avoid;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        margin-bottom: 20px;
        background: #000;
        cursor: pointer;
        /* Removed Bump Effect & Shadow on Hover */
        transition: opacity 0.3s ease;
      }
      
      .card:hover {
        opacity: 0.9; /* Subtle feedback */
      }

      .card img {
        width: 100%;
        height: auto;
        display: block;
        transition: transform 0.5s ease;
      }

      .card:hover img {
        transform: scale(1.03); /* Tiny zoom remains for interactivity? Or remove? User said "remove bumping", usually implies vertical move. Zoom is fine or remove? "just open the image preview" -> clean. Let's keep a VERY subtle zoom or just nothing. Let's keep tiny zoom for life. */
      }

      /* Removed Overlay CSS entirely from here as we will not render it */


      /* --- Enhanced Modal / Lightbox --- */
      .modal {
          position: fixed;
          inset: 0;
          backdrop-filter: blur(12px) brightness(40%);
          background: rgba(0,0,0,0.6);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }
      
      .modal-content {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 50px 100px -20px rgba(0,0,0,0.8);
        border-radius: 24px;
        padding: 30px;
        width: 95%;
        max-width: 500px;
        color: var(--text);
        text-align: left;
      }
      
      /* New Upload UI Classes */
      .upload-zone {
          border: 2px dashed rgba(255,255,255,0.1);
          border-radius: 16px;
          padding: 30px;
          text-align: center;
          transition: 0.3s;
          background: rgba(0,0,0,0.2);
          cursor: pointer;
          margin-bottom: 20px;
      }
      .upload-zone:hover {
          border-color: #FFD700;
          background: rgba(255, 215, 0, 0.05);
      }
      .upload-icon { font-size: 3rem; margin-bottom: 10px; display: block; opacity: 0.7; }

      .styled-input {
          width: 100%;
          background: rgba(0,0,0,0.3);
          border: 1px solid rgba(255,255,255,0.1);
          padding: 12px 16px;
          border-radius: 12px;
          color: white;
          margin-bottom: 15px;
          transition: 0.3s;
          font-size: 0.95rem;
          font-family: inherit;
      }
      .styled-input:focus {
          border-color: #FFD700;
          background: rgba(0,0,0,0.5);
          outline: none;
      }
      .input-label {
          display: block;
          margin-bottom: 6px;
          font-size: 0.85rem;
          color: #94a3b8;
          font-weight: 600;
          letter-spacing: 0.5px;
      }

      /* Lightbox Specific */
      .lightbox-img-container {
          background: #000;
          border-radius: 16px;
          overflow: hidden;
          margin-bottom: 20px;
          border: 1px solid rgba(255,255,255,0.1);
          box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      }
      
      /* --- Loader --- */
      .loader {
            width: 18px;
            height: 18px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
      @keyframes spin { to { transform: rotate(360deg); } }
      .hidden { display: none !important; }

      @media (max-width: 768px) {
        .gallery { columns: 2 160px; column-gap: 15px; } /* 2 columns on mobile */
        .gallery-header { justify-content: center; }
        .controls { justify-content: center; }
      }
      @media (max-width: 480px) {
          .gallery { columns: 1 auto; } /* 1 column on very small screens */
      }
      /* --- New Lightbox Styles --- */
      .lightbox-overlay {
          display: none;
          position: fixed;
          inset: 0;
          z-index: 10000;
          background: rgba(0, 0, 0, 0.95);
          flex-direction: row;
          overflow: hidden;
      }
      
      .lightbox-main {
          flex: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          height: 100vh;
      }

      .lightbox-main img {
          max-height: 90vh;
          max-width: 90%;
          object-fit: contain;
          box-shadow: 0 0 50px rgba(0,0,0,0.5);
          transition: opacity 0.3s ease;
      }

      .nav-btn {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          background: rgba(255, 255, 255, 0.1);
          border: none;
          color: white;
          font-size: 2rem;
          padding: 20px 15px;
          cursor: pointer;
          transition: all 0.2s;
          border-radius: 8px;
          z-index: 10;
      }
      .nav-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-50%) scale(1.1); }
      .prev-btn { left: 20px; }
      .next-btn { right: 20px; }

      .lightbox-sidebar {
          width: 350px;
          height: 100vh;
          background: #0f172a;
          border-left: 1px solid rgba(255,255,255,0.1);
          display: flex;
          flex-direction: column;
          padding: 0;
          position: relative;
          flex-shrink: 0;
      }

      /* Close Button at Top Right of Sidebar/Screen */
      .close-btn {
          position: absolute;
          top: 15px;
          right: 15px;
          background: transparent;
          border: none;
          color: #94a3b8;
          font-size: 1.5rem;
          cursor: pointer;
          z-index: 20;
          transition: 0.2s;
      }
      .close-btn:hover { color: #fff; transform: rotate(90deg); }

      .sidebar-content {
          padding: 30px 20px;
          overflow-y: auto;
          flex: 1;
      }

      .memory-meta { margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
      .memory-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-bottom: 10px; color: #FFD700; }
      .memory-desc { color: #cbd5e1; line-height: 1.6; font-size: 1rem; }
      
      .action-row { display: flex; gap: 15px; margin-bottom: 25px; }
      .action-btn { 
          flex: 1; 
          background: rgba(255,255,255,0.05); 
          border: 1px solid rgba(255,255,255,0.1); 
          color: #cbd5e1; 
          padding: 8px; 
          border-radius: 8px; 
          cursor: pointer; 
          display: flex; align-items: center; justify-content: center; gap: 8px;
          transition: 0.2s;
      }
      .action-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
      
      .comments-area {
          background: rgba(0,0,0,0.2);
          border-radius: 12px;
          padding: 15px;
          display: flex;
          flex-direction: column;
          flex: 1;
      }
      .comments-list {
          flex: 1;
          overflow-y: auto;
          margin-bottom: 15px;
          max-height: 300px;
      }
      .comment-item {
          font-size: 0.9rem;
          color: #94a3b8;
          margin-bottom: 8px;
          padding-bottom: 8px;
          border-bottom: 1px solid rgba(255,255,255,0.05);
      }

      /* Mobile Responsive */
      @media (max-width: 900px) {
          .lightbox-overlay { flex-direction: column; }
          .lightbox-main { height: 60vh; }
          .lightbox-sidebar { width: 100%; height: 40vh; border-left: none; border-top: 1px solid rgba(255,255,255,0.1); }
          .nav-btn { padding: 10px; font-size: 1.5rem; }
      }
      /* Tags */
      .tag-chip {
        background: rgba(255, 215, 0, 0.1);
        border: 1px solid rgba(255, 215, 0, 0.3);
        color: #FFD700;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: 0.2s;
      }
      .tag-chip:hover {
        background: rgba(255, 215, 0, 0.3);
      }

      /* ================= MOBILE RESPONSIVE ================= */
      @media (max-width: 600px) {
          /* Header Adjustments */
          .content h1 {
              font-size: 2.2rem !important; /* Force smaller size */
              padding: 0 10px;
          }
          .content p {
              font-size: 0.9rem !important;
          }
          .main-page .content {
              padding-top: 80px; /* Space for top button */
          }
          
          /* Gallery Grid */
          .gallery {
              columns: 1 auto; /* Single column for better view */
              column-gap: 0;
          }
          
          /* Dock Adjustments */
          .dock-container {
              bottom: 20px;
              right: 50%;
              transform: translateX(50%); /* Center the dock */
              width: 90%;
              justify-content: center;
          }
          .glass-dock {
              width: 100%;
              justify-content: space-around; /* Distribute icons evenly */
              padding: 12px 20px;
          }
          .dock-search-wrapper { display: none; } /* Hide search on mobile to save space, or make it a popout? User asked for responsive. Hiding text input in dock is standard pattern. */

          /* Modal Adjustments */
          .modal-content {
              width: 90%;
              padding: 20px;
              margin: 0 10px;
          }
          
          /* Top Button */
          .enter-btn[onclick*="invitation.html"] {
              top: 15px !important;
              right: 15px !important;
              font-size: 0.8rem !important;
              padding: 8px 12px !important;
          }
      }
    </style>

    </style>
  </head>

  <body>
    <!-- Background Music -->
    <audio id="globalMusic" src="music1.mp3" loop autoplay></audio>

      <!-- Main Page Wrapper -->
    <div class="main-page">
      <video class="main-video" autoplay muted loop>
        <source src="video3.mp4" />
      </video>

      <div class="content">
        
        <!-- Top Right Invitation Button -->
        <button class="enter-btn" onclick="window.location.href='invitation.html'" 
                style="position: absolute; top: 30px; right: 30px; width: auto; padding: 10px 20px; height: auto; font-size: 1rem; z-index: 10; background: linear-gradient(135deg, #FFD700, #FFA500); color: black;">
            View Invitation ‚ûî
        </button>
        
        <!-- Redesigned Minimal Header -->
        <div style="text-align: center; margin-bottom: 50px; position: relative;">
            <h1 style="font-family:'Playfair Display', serif; font-size: 3.5rem; margin-bottom: 5px; 
                       background: linear-gradient(to bottom, #fff, #94a3b8); -webkit-background-clip: text; 
                       background-clip: text; color: transparent; text-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                Farewell Memories
            </h1>
            <p style="color: #94a3b8; font-size: 1.1rem; letter-spacing: 2px; text-transform: uppercase;">
                Moments We'll Never Forget üí´
            </p>
        </div>

        <!-- Gallery Container -->
        <div class="gallery-container">
          <!-- Gallery Grid -->
          <div class="gallery" id="gallery"></div>
          
          <!-- Floating Glass Dock (Fixed Bottom) -->
          <div class="dock-container">
            <div class="glass-dock">
                <!-- Home / Logout -->
                <button class="dock-btn" onclick="window.location.href='index.html'" title="Home">
                    üè†
                </button>
                
                <!-- Search -->
                <div class="dock-search-wrapper">
                    <input id="search" placeholder="Search memories..." />
                </div>

                <!-- Add Photo (Central Action) -->
                <button class="dock-btn primary" id="uploadBtn" title="Add Photo">
                    +
                </button>

                <!-- Admin -->
                <button class="dock-btn" id="adminBtn" title="Admin Login" style="color: #ef4444;">
                    üîê
                </button>
            </div>
          </div>

          <!-- Upload Modal -->
          <div class="modal" id="uploadModal">
            <div class="modal-content">
              <h3 style="color:white; margin-bottom:20px; font-family:'Playfair Display', serif; font-size:1.5rem;">Add Memory üì∏</h3>
          
              <div class="upload-zone" onclick="document.getElementById('imageInput').click()">
                  <span class="upload-icon">‚òÅÔ∏è</span>
                  <div style="color:#cbd5e1; font-weight:500;">Click to Upload Image</div>
                  <div style="font-size:0.8rem; color:#64748b; margin-top:5px;">JPG, PNG supported</div>
              </div>
              <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="alert('Photo Selected: ' + this.files[0].name)">
              
              <label class="input-label">Your Name</label>
              <input id="nameInput" class="styled-input" placeholder="e.g. Sahil">

              <label class="input-label">Description</label>
              <textarea id="descInput" class="styled-input" rows="3" placeholder="Write about this moment..."></textarea>
          
              <label class="input-label">Tags</label>
              <div id="tags-container" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px;">
                <span class="tag-chip" onclick="addTag('Besties')">Besties ‚ù§Ô∏è</span>
                <span class="tag-chip" onclick="addTag('Squad')">Squad üî•</span>
                <span class="tag-chip" onclick="addTag('Farewell')">Farewell üéì</span>
                <span class="tag-chip" onclick="addTag('Forever')">Forever ‚ôæÔ∏è</span>
                <span class="tag-chip" onclick="addTag('Class of 26')">Class of '26 üèÜ</span>
              </div>
              <input id="catInput" class="styled-input" placeholder="Custom tags...">
          
              <div style="margin-top:25px; display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="uploadPhoto()" id="saveBtn" style="padding: 10px 24px;">
                    <div id="loader" class="hidden"><span class="loader"></span></div>
                    <span id="btnText">Post Memory</span>
                </button>
                <button onclick="closeModal()" style="background:transparent; border:1px solid rgba(255,255,255,0.2); padding: 10px 20px;">Cancel</button>
              </div>
            </div>
          </div>
          
          <!-- Lightbox -->
          <!-- Admin Login Modal -->
          <div class="modal" id="adminModal">
            <div class="modal-content" style="max-width: 400px; text-align:center;">
              <h3 style="color:white; margin-bottom:20px; font-family:'Playfair Display', serif; font-size:1.5rem;">Admin Access üîê</h3>
              
              <label class="input-label" style="text-align:left;">Username</label>
              <input id="adminUser" class="styled-input" placeholder="Admin Username">

              <label class="input-label" style="text-align:left;">Password</label>
              <input id="adminPass" type="password" class="styled-input" placeholder="Password">

              <div style="margin-top:25px; display:flex; gap:10px; justify-content:center;">
                <button onclick="checkAdminLogin()" style="padding: 10px 24px;">Login</button>
                <button onclick="closeAdminModal()" style="background:transparent; border:1px solid rgba(255,255,255,0.2); padding: 10px 20px;">Cancel</button>
              </div>
            </div>
          </div>
          
          <!-- Lightbox -->
          <!-- Lightbox (New Layout) -->
          <div id="lightbox" class="lightbox-overlay">
            
            <div class="lightbox-main">
                <button class="nav-btn prev-btn" onclick="prevImage(event)">&#10094;</button>
                <img id="lightImg" src="" alt="Memory">
                <button class="nav-btn next-btn" onclick="nextImage(event)">&#10095;</button>
            </div>

            <div class="lightbox-sidebar">
                <button class="close-btn" onclick="closeLightbox()" title="Close">&times;</button>
                
                <div class="sidebar-content">
                    <div class="memory-meta">
                        <h3 id="lightName" class="memory-title"></h3>
                        <p id="lightDesc" class="memory-desc"></p>
                    </div>

                    <div class="action-row">
                        <button class="action-btn" onclick="likeMemory()">
                            <span>‚ù§Ô∏è</span> <span id="likeCount">0</span>
                        </button>
                        <button class="action-btn">
                            <span>üè∑Ô∏è</span> <span style="font-size:0.8rem">Tag</span>
                        </button>
                        <!-- Delete button injected here if admin -->
                        <div id="deleteContainer" style="display:contents;"></div>
                    </div>

                    <div class="comments-area">
                        <h4 style="margin-bottom:10px; font-size:0.9rem; text-transform:uppercase; color:#64748b;">Comments</h4>
                        <div id="commentList" class="comments-list"></div>
                        
                        <div style="display:flex; gap:8px;">
                            <input id="commentInput" class="styled-input" style="margin:0; font-size:0.85rem;" placeholder="Add a comment...">
                            <button onclick="addComment()" style="background:#FFD700; color: black; border:none; border-radius:8px; padding:0 12px; cursor:pointer;">‚û§</button>
                        </div>
                    </div>
                </div>
            </div>
          </div>
        </div>

        <!-- Footer Link (Invitation) -->

      </div>
    </div>

    <script>
      // ================= CONFIGURATION =================
      const CLOUD_NAME = 'dj8igz7kg'; 
      const UPLOAD_PRESET = 'Upload'; 
      const TAG = 'farewell_memory_v1';
      // =================================================

      // State
      let photos = [];
      let isAdmin = false;
      let myUploads = JSON.parse(localStorage.getItem('my_uploads') || "[]");
      let deletedIds = JSON.parse(localStorage.getItem('deleted_ids') || "[]");
      let allComments = JSON.parse(localStorage.getItem('all_comments') || "{}");
      let allLikes = JSON.parse(localStorage.getItem('all_likes') || "{}"); // Persistent Likes
      let myLikedPhotos = JSON.parse(localStorage.getItem('my_liked_photos') || "[]"); // Track user likes
      let currentLightboxId = null;
      let currentUserDevice = localStorage.getItem('device_id') || generateDeviceId();

      // Generate a unique device ID for uploader tracking
      function generateDeviceId() {
        const id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('device_id', id);
        return id;
      }

      const galleryEl = document.getElementById("gallery");
      const uploadModal = document.getElementById("uploadModal");
      const adminModal = document.getElementById("adminModal");
      const searchInput = document.getElementById("search");
      const saveBtn = document.getElementById("saveBtn");
      const loader = document.getElementById("loader");
      const btnText = document.getElementById("btnText");

      // Track uploader info for each photo (device_id + timestamp)
      let uploaderInfo = JSON.parse(localStorage.getItem('uploader_info') || "{}");

      // -------- Admin Login --------
      document.getElementById("adminBtn").onclick = () => {
          if (isAdmin) {
              // Show logout option if already admin
              if (confirm("You are logged in as Admin. Logout?")) {
                  isAdmin = false;
                  alert("Logged out as Admin.");
                  render(); // Re-render to hide delete buttons
              }
              return;
          }
          // Fix Z-Index issue
          adminModal.style.zIndex = "20000";
          adminModal.style.display = "flex";
      };

      function closeAdminModal() {
          adminModal.style.display = "none";
          document.getElementById("adminUser").value = "";
          document.getElementById("adminPass").value = "";
      }

      function checkAdminLogin() {
          const u = document.getElementById("adminUser").value.trim().toLowerCase();
          const p = document.getElementById("adminPass").value;

          // Admin credentials
          const allowedAdmins = ["sahil", "shivam"];
          const adminPassword = "admin123";
          
          if (allowedAdmins.includes(u)) {
              if (p === adminPassword) {
                  isAdmin = true;
                  alert(`‚úÖ Welcome Admin ${u.charAt(0).toUpperCase() + u.slice(1)}! You can now delete ANY photo.`);
                  closeAdminModal();
                  render(); // Re-render to show admin delete buttons
              } else {
                  alert("‚ùå Wrong password!");
              }
          } else {
              alert("‚ùå Access Denied: Invalid Username.");
          }
      }

      // -------- Tag Logic --------
      function addTag(tag) {
          const input = document.getElementById('catInput');
          const currentVal = input.value.trim();
          if (currentVal) {
              input.value = currentVal + ", " + tag;
          } else {
              input.value = tag;
          }
      }

      // -------- Like Logic --------
      function likeMemory() {
          if (!currentLightboxId) return;

          const photo = photos.find(p => p.id === currentLightboxId);
          if (!photo) return;

          // Check if already liked
          if (myLikedPhotos.includes(currentLightboxId)) {
              alert("You already liked this memory! ‚ù§Ô∏è");
              return;
          }

          // Increment count
          photo.likes = (photo.likes || 0) + 1;
          
          // Save to allLikes storage
          allLikes[currentLightboxId] = photo.likes;
          localStorage.setItem('all_likes', JSON.stringify(allLikes));

          // Save to myLikedPhotos storage
          myLikedPhotos.push(currentLightboxId);
          localStorage.setItem('my_liked_photos', JSON.stringify(myLikedPhotos));

          // Update UI
          const likeCountEl = document.getElementById('likeCount');
          if (likeCountEl) likeCountEl.innerText = photo.likes;

          // Animate button
          const btn = document.querySelector('.action-btn'); // The Like button is 1st
          if(btn) {
            btn.style.transform = "scale(1.2)";
            setTimeout(() => btn.style.transform = "scale(1)", 200);
          }
      }

      // -------- Cloudinary Logic --------
      async function loadMemories() {
        try {
            const response = await fetch(`https://res.cloudinary.com/${CLOUD_NAME}/image/list/${TAG}.json`);
            if (!response.ok) {
                if(response.status === 404) console.warn("Resource list empty or disabled.");
                return;
            }
            const data = await response.json();
            
            // Map Cloudinary resources to our app structure
            photos = data.resources.map(res => {
                let name = "Student";
                let desc = "A memory...";
                let cat = "uncategorized";
                
                // Decode metadata from public_id
                try {
                    const parts = res.public_id.split('_');
                    if (parts.length >= 3) {
                        const encoded = parts.slice(2).join('_');
                        const base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
                        const decoded = JSON.parse(atob(base64));
                        if(decoded.n) name = decoded.n;
                        if(decoded.c) desc = decoded.c;
                        if(decoded.cat) cat = decoded.cat;
                    }
                } catch (e) {
                    console.warn("Decode fail", res.public_id);
                }

                return {
                    id: res.public_id,
                    src: `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/v${res.version}/${res.public_id}.${res.format}`,
                    name: name,
                    description: desc,
                    category: cat,
                    likes: allLikes[res.public_id] || 0, // Load persistent likes
                    comments: allComments[res.public_id] || [],
                    isMine: myUploads.includes(res.public_id) || 
                            (uploaderInfo[res.public_id] && 
                             uploaderInfo[res.public_id].deviceId === currentUserDevice)
                };
            });

            // Filter out deleted ones
            photos = photos.filter(p => !deletedIds.includes(p.id));

            render();
        } catch (err) {
            console.error(err);
        }
      }

      async function uploadPhoto() {
        const file = document.getElementById("imageInput").files[0];
        const name = document.getElementById("nameInput").value.trim();
        const desc = document.getElementById("descInput").value.trim();
        const cat = document.getElementById("catInput").value.trim() || "uncategorized";

        if (!file || !name || !desc) {
            alert("Please fill all fields and choose a photo!");
            return;
        }

        // UI Loading
        saveBtn.disabled = true;
        loader.classList.remove('hidden');
        btnText.classList.add('hidden');

        // Encode Metadata
        const metadata = JSON.stringify({ n: name, c: desc, cat: cat });
        const encodedData = btoa(metadata).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        const publicId = `mem_${Date.now()}_${encodedData}`;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', UPLOAD_PRESET);
        formData.append('public_id', publicId);
        formData.append('tags', TAG);

        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: 'POST', body: formData
            });
            const data = await res.json();

            if (data.secure_url) {
                // Success! Track this upload
                myUploads.push(data.public_id);
                localStorage.setItem('my_uploads', JSON.stringify(myUploads));
                
                // Track User Name
                localStorage.setItem('user_name', name);
                currentUserName = name;
                updateStatus(`${name} üë§`);

                // Store uploader info
                uploaderInfo[data.public_id] = {
                    deviceId: currentUserDevice,
                    timestamp: Date.now()
                };
                localStorage.setItem('uploader_info', JSON.stringify(uploaderInfo));

                alert("Memory Posted! üöÄ");
                closeModal();
                loadMemories();
                
                // Clear inputs
                document.getElementById("imageInput").value = "";
                document.getElementById("nameInput").value = "";
                document.getElementById("descInput").value = "";
                document.getElementById("catInput").value = "";
            } else {
                alert("Upload failed.");
            }
        } catch (e) {
            console.error(e);
            alert("Error uploading.");
        } finally {
            saveBtn.disabled = false;
            loader.classList.add('hidden');
            btnText.classList.remove('hidden');
        }
      }

      // -------- Render Gallery --------
      function render() {
        galleryEl.innerHTML = "";
        const s = searchInput.value.toLowerCase();
        const displayPhotos = [...photos].reverse();

        displayPhotos.forEach((p, i) => {
            if (!p.description.toLowerCase().includes(s) && 
                !p.name.toLowerCase().includes(s) && 
                !p.category.toLowerCase().includes(s)) return;

            const card = document.createElement("div");
            card.className = "card";

            // Add data attribute for tracking
            card.dataset.photoId = p.id;
            card.dataset.isMine = p.isMine;

            // Click on card opens lightbox
            card.onclick = () => openLightbox(p);
            
            const img = document.createElement("img");
            img.src = p.src;
            img.loading = "lazy";
            
            // CLEAN VIEW: No delete indicator here. Only in Lightbox.

            card.appendChild(img);
            galleryEl.appendChild(card);
        });
      }

      // -------- Delete Photo Function --------
      function deletePhoto(id) {
        if (!confirm("Are you sure you want to delete this memory? This action cannot be undone.")) return;

        // Check permissions (this should already be verified, but double-check)
        const photo = photos.find(p => p.id === id);
        if (!photo) return;

        if (!isAdmin && !photo.isMine) {
            alert("‚ùå You don't have permission to delete this photo.");
            return;
        }

        // Add to deleted IDs
        deletedIds.push(id);
        localStorage.setItem('deleted_ids', JSON.stringify(deletedIds));
        
        // Remove from UI
        photos = photos.filter(p => p.id !== id);
        render();
        
        // Close lightbox if it's open for this photo
        if (currentLightboxId === id) {
            closeLightbox();
        }
        
        alert("‚úÖ Memory deleted successfully.");
      }

      // -------- Lightbox Functions --------
      function openLightbox(p) {
          currentLightboxId = p.id;
          document.getElementById('lightImg').src = p.src;
          document.getElementById('lightName').innerText = p.name;
          document.getElementById('lightDesc').innerText = p.description;
          document.getElementById('likeCount').innerText = p.likes;
          
          // Render Comments
          renderComments(p.comments);

          // Check permissions for delete button
          const delContainer = document.getElementById('deleteContainer');
          delContainer.innerHTML = "";
          
          if (isAdmin || p.isMine) {
              const btn = document.createElement('button');
              btn.className = 'action-btn';
              btn.style.color = '#ef4444'; 
              btn.style.borderColor = 'rgba(239, 68, 68, 0.3)';
              btn.innerHTML = 'üóëÔ∏è Delete';
              btn.onclick = () => {
                  deletePhoto(p.id);
              };
              delContainer.appendChild(btn);
          }

          document.getElementById('lightbox').style.display = 'flex';
      }

      function closeLightbox() {
          document.getElementById('lightbox').style.display = 'none';
          currentLightboxId = null;
      }

      function renderComments(comments) {
          const list = document.getElementById('commentList');
          list.innerHTML = "";
          if (!comments || comments.length === 0) {
              list.innerHTML = "<div style='text-align:center; color:rgba(255,255,255,0.3); margin-top:20px;'>No comments yet. Be the first!</div>";
              return;
          }
          comments.forEach((c, i) => {
              const item = document.createElement('div');
              item.className = 'comment-item';
              item.style.display = 'flex';
              item.style.justifyContent = 'space-between';
              item.innerHTML = `
                <div>
                    <strong style="color:#FFD700">${c.user}</strong>: <span style="color:#cbd5e1">${c.text}</span>
                </div>
                <button onclick="deleteComment('${currentLightboxId}', ${i})" style="background:transparent; border:none; color:#64748b; cursor:pointer;" title="Delete">x</button>
              `;
              list.appendChild(item);
          });
      }

      function addComment() {
         if (!currentLightboxId) return;
         const input = document.getElementById('commentInput');
         const text = input.value.trim();
         if (!text) return;

         const photo = photos.find(p => p.id === currentLightboxId);
         if (photo) {
             const newComment = { user: "You", text: text, date: Date.now() };
             photo.comments.push(newComment);
             
             // Save to LocalStorage
             if (!allComments[currentLightboxId]) allComments[currentLightboxId] = [];
             allComments[currentLightboxId].push(newComment);
             localStorage.setItem('all_comments', JSON.stringify(allComments));
             
             renderComments(photo.comments);
             input.value = "";
         }
      }

      function deleteComment(photoId, index) {
          const photo = photos.find(p => p.id === photoId);
          if (photo) {
              photo.comments.splice(index, 1);
              
              // Update Storage
              if (allComments[photoId]) {
                  allComments[photoId].splice(index, 1);
                  localStorage.setItem('all_comments', JSON.stringify(allComments));
              }
              
              renderComments(photo.comments);
          }
      }

      function prevImage(e) {
          e.stopPropagation();
          if(!currentLightboxId) return;
          const idx = photos.findIndex(p => p.id === currentLightboxId);
          if(idx > 0) openLightbox(photos[idx - 1]);
      }

      function nextImage(e) {
          e.stopPropagation();
          if(!currentLightboxId) return;
          const idx = photos.findIndex(p => p.id === currentLightboxId);
          if(idx < photos.length - 1) openLightbox(photos[idx + 1]);
      }
      
      function likeMemory() {
          const count = document.getElementById('likeCount');
          count.innerText = parseInt(count.innerText) + 1;
      }

      // -------- UI Helper Functions --------
      function addTag(tag) {
          const input = document.getElementById('catInput');
          if (input.value) input.value += ", " + tag;
          else input.value = tag;
      }
      
      document.getElementById("uploadBtn").onclick = () => {
          document.getElementById("uploadModal").style.display = "flex";
      };
      
      function closeModal() { 
          document.getElementById("uploadModal").style.display = "none"; 
      }

      // Close modals on outside click
      window.onclick = function(event) {
          if (event.target == uploadModal) {
              closeModal();
          }
          if (event.target == adminModal) {
              closeAdminModal();
          }
          if (event.target == document.getElementById('lightbox')) {
              closeLightbox();
          }
      }

      // Initialize
      window.onload = loadMemories;
      searchInput.oninput = render;

      // Add some CSS for the delete indicator
      const style = document.createElement('style');
      style.textContent = `
        .delete-indicator {
            opacity: 0.6;
            transition: opacity 0.3s;
        }
        .delete-indicator:hover {
            opacity: 1;
            background: rgba(239, 68, 68, 0.8) !important;
            transform: scale(1.1);
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
